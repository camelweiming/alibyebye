<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.abb.bye.mapper.ProxyMapper">

    <sql id="columns">
        id,
        gmt_create,
        gmt_modified,
        host,
        avg_cost,
        success_rate,
        source,
        attributes,
        failed_count
    </sql>

    <insert id="insert" parameterType="com.abb.bye.client.domain.ProxyDO">
        insert proxy
        ( id, gmt_create, gmt_modified, host, avg_cost, success_rate, source, attributes,failed_count)
        values
        ( #{id}, now() ,now(), #{host}, #{avgCost}, #{successRate}, #{source}, #{attributes},#{failedCount})
         ON DUPLICATE KEY UPDATE
        gmt_modified=now()
        <if test="avgCost!=null">,avg_cost=#{avgCost}</if>
        <if test="successRate!=null">,success_rate=#{successRate}</if>
        <if test="failedCount==-1">,failed_count=0</if>
        <if test="failedCount>=0">,failed_count=failed_count+#{failedCount}</if>
    </insert>

    <select id="list" resultType="string">
        select host from proxy where
        <![CDATA[ failed_count<#{maxFailedCount} ]]>
        order by success_rate desc ,avg_cost asc ,failed_count asc
        limit #{length}
    </select>

    <select id="listAll" resultType="string">
        select host from proxy where
        <![CDATA[
          id > #{id}
          and  failed_count<#{maxFailedCount}
        ]]>
        order by id asc
        limit #{length}
    </select>

</mapper>